# üëá ‡πÉ‡∏ä‡πâ Image Node.js ‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
FROM node:18-alpine AS builder

RUN apk add --no-cache tzdata \
    && cp /usr/share/zoneinfo/Asia/Bangkok /etc/localtime \
    && echo "Asia/Bangkok" > /etc/timezone
    
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Working Directory
WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å package.json ‡πÅ‡∏•‡∏∞ lockfile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ install dependencies ‡∏Å‡πà‡∏≠‡∏ô
COPY package.json package-lock.json* yarn.lock* ./
COPY .env.jtekt /app/.env

# ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á dependencies ‡πÅ‡∏ö‡∏ö production ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
RUN yarn install --frozen-lockfile

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ
COPY . .

# Build Next.js
RUN yarn build

# üëá ‡πÉ‡∏ä‡πâ Image ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Production
FROM node:18-alpine AS runner

WORKDIR /app

# ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà build ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å stage `builder`
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/scripts ./scripts

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Port ‡∏ó‡∏µ‡πà Container ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
EXPOSE 3000

# ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ Container ‡∏£‡∏±‡∏ô
CMD ["yarn", "run", "start-jtekt"]
